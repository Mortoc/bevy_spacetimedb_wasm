<!DOCTYPE html>
<html>
<head>
    <title>Manual SDK Event Handler Test</title>
    <meta charset="utf-8">
</head>
<body>
    <h1>Manual SDK Event Handler Test</h1>
    <div id="log"></div>

    <script type="module">
        import { DbConnection } from './generated/index.js';

        const log = msg => {
            const div = document.getElementById('log');
            div.innerHTML += `<div>${new Date().toISOString()} - ${msg}</div>`;
            console.log(msg);
        };

        async function test() {
            try {
                log('Creating connection...');
                const conn = DbConnection.builder()
                    .withUri('http://localhost:3000')
                    .withModuleName('test-module')
                    .build();

                // Set up connection handlers
                conn.onConnect((ctx, identity, token) => {
                    log(`‚úì Connected! Identity: ${identity.toHexString().substring(0, 16)}...`);
                });

                conn.onConnectError((ctx, error) => {
                    log(`‚ùå Connection error: ${error}`);
                });

                log('Setting up subscription...');
                let insertCount = 0;

                // Subscribe to all tables and set up event handler
                const sub = conn.subscriptionBuilder()
                    .onApplied((ctx) => {
                        log('‚úì Subscription applied!');
                        log(`Tables in db: ${Object.keys(conn.db).join(', ')}`);

                        // Check if testPlayer table exists
                        if (conn.db.testPlayer) {
                            log(`‚úì testPlayer table found, count: ${conn.db.testPlayer.count()}`);

                            // Register insert handler
                            conn.db.testPlayer.onInsert((ctx, row) => {
                                insertCount++;
                                log(`üì• INSERT EVENT #${insertCount}: ${JSON.stringify(row)}`);
                                log(`   Event context: ${JSON.stringify(ctx.event)}`);
                            });

                            log('‚úì onInsert handler registered');

                            // Now call reducer to create a player
                            log('Calling create_player reducer...');
                            conn.callReducer('create_player', 888, 'ManualTestPlayer')
                                .then(() => {
                                    log('‚úì Reducer called successfully');
                                })
                                .catch(err => {
                                    log(`‚ùå Reducer call failed: ${err}`);
                                });
                        } else {
                            log('‚ùå testPlayer table not found!');
                        }
                    })
                    .onError((ctx, error) => {
                        log(`‚ùå Subscription error: ${error}`);
                    })
                    .subscribeToAllTables();

                log('Subscription initiated');

            } catch (error) {
                log(`‚ùå Error: ${error}`);
                console.error(error);
            }
        }

        test();
    </script>
</body>
</html>
