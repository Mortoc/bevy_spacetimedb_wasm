<!DOCTYPE html>
<html>
<head>
    <title>Standalone SDK Test</title>
</head>
<body>
    <h1>Standalone SDK Test</h1>
    <div id="log"></div>

    <script type="module">
        import { DbConnection } from './generated/index.js';

        const log = (msg) => {
            const timestamp = new Date().toISOString().split('T')[1];
            console.log(`[${timestamp}] ${msg}`);
            document.getElementById('log').innerHTML += `<div>[${timestamp}] ${msg}</div>`;
        };

        log('üöÄ Starting standalone SDK test...');

        const conn = DbConnection.builder()
            .withUri('http://localhost:3000')
            .withModuleName('test-module')
            .onConnect((connection, identity, token) => {
                log(`‚úÖ Connected! Identity: ${identity.toHexString()}`);

                // Step 1: Register onInsert handler FIRST
                log('üìù Registering onInsert handler...');
                connection.db.testPlayer.onInsert((ctx, row) => {
                    log(`üéâ INSERT EVENT FIRED! Row: ${JSON.stringify(row)}`);
                });
                log('‚úÖ Handler registered');

                // Step 2: Subscribe to all tables
                log('üìã Subscribing to all tables...');
                connection.subscriptionBuilder()
                    .onApplied(() => {
                        log('‚úÖ Subscription applied');
                        log(`   Table count: ${connection.db.testPlayer.count()}`);

                        // Step 3: Call a reducer to insert a row
                        log('üì§ Calling createPlayer reducer...');
                        connection.reducers.createPlayer(777, 'StandaloneTest')
                            .then(() => {
                                log('‚úÖ Reducer called successfully');
                                log('‚è≥ Waiting for insert event...');
                            })
                            .catch(err => log(`‚ùå Reducer error: ${err}`));
                    })
                    .onError((ctx, error) => {
                        log(`‚ùå Subscription error: ${error}`);
                    })
                    .subscribeToAllTables();
            })
            .onConnectError((ctx, error) => {
                log(`‚ùå Connection error: ${error}`);
            })
            .build();

        log('Connection building complete');
    </script>
</body>
</html>
